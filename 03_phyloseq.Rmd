---
title: "03_Phyloseq tutorial"
output:
  github_document:
    toc: yes
    toc_depth: 5
---
Ce document R, sert pour des analyses grâce au package de phyloseq. 

# Introduction 
## Appele des librarys 

```{r}
library(ggplot2)
library(dada2)
library(phyloseq)
library(dada2)
library(ggplot2)
library(dplyr)
library(reshape2)
library(ade4)
library(ggrepel)
library(lattice)
library(igraph)
library(ggnetwork)
```

#" Les données de la rade de Brest après analyse avec dada2

```{r}
load("~/CC2_Ecog2/02_Dada2_tutorial_FinalEnv")
```

# Analyse avec phyloseq

## Combiner les données dans un objet phyloseq

-samdf = une fonction qui va permmettre de faire un graph qui englobe les ensembles de données
```{r}
samples.out <- rownames(seqtab.nochim)
profondeur <- sapply(strsplit(samples.out, "D"), `[`, 1)
date <- substr(profondeur,0,1557)
samdf <- data.frame(Profondeur=profondeur, Date=date)
samdf$Profondeur[samdf$Date>1557] <- c("Fond","Median","Surface")
samdf$Date[samdf$Profondeur>1557] <- c("10sept14","11mars15")
rownames(samdf) <- samples.out
```


```{r}
write.csv(samdf, "samdf.csv")
```
on crée une fichier samdf avec nos échantillons, nous allon réorganiser les donnée pour que les échantillons correspond a leur profondeur et leurs dates. 

```{r}
samdf <-read.table("~/CC2_Ecog2/samdf.csv", sep=",", header=TRUE, row.names = 1)
```

## Arbre phylogénétique 
```{r}
library(phangorn)
library(DECIPHER)
seqs <- getSequences(seqtab.nochim)
names(seqs) <- seqs # This propagates to the tip labels of the tree
alignment <- AlignSeqs(DNAStringSet(seqs), anchor=NA,verbose=FALSE)
phangAlign <- phyDat(as(alignment, "matrix"), type="DNA")
dm <- dist.ml(phangAlign)
treeNJ <- NJ(dm) # Note, tip order != sequence order
fit = pml(treeNJ, data=phangAlign)
fitGTR <- update(fit, k=4, inv=0.2)
fitGTR <- optim.pml(fitGTR, model="GTR", optInv=TRUE, optGamma=TRUE,
        rearrangement = "stochastic", control = pml.control(trace = 0))
detach("package:phangorn", unload=TRUE)
```

```{r}
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxa), phy_tree(fitGTR$tree))
ps
```

## Les indices de diversité : alpha 

Les  indices  de  diversité sont  basés  sur  des  formules  plus  complexes  et  illustrant  la  complexité  des  peuplements  : Indice  de  Shannon  Wiener  (H’),  Indice de Simpson ...  Ces indices prends en compte le  nombre  d’espèces et la  distribution des individus au sein de ces espèces. 

l’indice  de  Shannon  est  sensibles  aux  variations  d’importance  des  espèces les plus rares. Quand plus inice de shannon (est bas) = des epèce rare. 

l’indice de Simpson est sensibles aux variations d’importance des espèces les plus abondantes.
```{r}
plot_richness(ps, x="Date", measures=c("Shannon", "Simpson"), color="Profondeur")
```

l’indice  de  Shannon  est  sensible  aux  variations  d’importance  des  espèces les plus rares. Lorsque l'indice de Shannon est bas, cela signifie que des espèces rares sont retrouvées plus facilement et qu'il y a une espèce plus présente par rapport aux autres, par exemple pour la surface le 10 septembre 2014, on a un indice de Shannon qui est inférieur à 4,5. Pour le médian, un indice entre 4,5 et 4,8 et pour le fond, un indice supérieur à 5,1. Cela signifie donc, il y a plus d'espèces rares de manière croissante en partant du fond vers la surface. En revanche, en mars 2015, l'indice de Shannon est supérieur à 5,1 qu'on se trouve en fond ou à la surface, ceci montre ainsi qu'il y a peu d'espèce rare. Il y a donc une grande différence des espèces en surface selon les deux dates. En effet il y a beaucoup plus d'espèces rares en 2014. L'abondance en fond est donc mieux répartie. 

l’indice de Simpson est sensibles aux variations d’importance des espèces les plus abondantes. Lorsque l'indice de Simpson tends vers 0, cela signifie que les échantillons représentent une grande diversité, contrairement à 1 qui représente une faible diversité. Pour les échantillons de 2014, les surfaces sont compris entre 0,96 et 0,95, les médians entre 0,97 et 0,98 et enfin les fonds sont supérieurs à 0,98. Les échantillons de la surface présentent une forte diversité par rapport à ceux du fond, cependant, il faut prendre en compte que l'indice de Simppson, que tout les échantillons tendent vers 1 et ne sont donc pas significatifs. Il faudrait, pour cela effectuer des tests statiitiques. 
Pour mars 2015, tous les échntillons que ce soit en fond ou en surface, les indices sont supérieurs à 0,98, ils présentent donc une plus faible diversité. On voit bien qu'il y a une différence au niveau de la diversité aux différents moments de l'année. Les résultats avec l'indice de Shannon concordent avec ceux de l'indice de Simpson.



## Filtrage de la taxonomie
### Indiquer les rangs dans l'ensemble des données

La fonction rank-names: permet de déterminer les rangs taxonomiques de taxa.print
```{r}
rank_names(taxa.print)
```

### Créer un tableau, nombre de caractéristiques pour chaque phyla

La fonction tax_table : permet de construire et d’accéder à une table de nom taxonomique de l’objet taxa.print

Table : permet faire un tableau de contingence en fonction de différents facteurs, ajout tax_table, au niveau du phylum, il exclut quand ce ne sont pas des phyla. Le résultat indique le nombre de séquences appartenant au phylum désigné. 

```{r}
table(tax_table(ps)[, "Phylum"], exclude = NULL)
```

### Créer une table avec le nombre dans chaque phyla
```{r}
ps <- subset_taxa(ps, !is.na(Phylum) & !Phylum %in% c("", "uncharacterized"))
```
Les NA sont des artefacts dans le jeu de données, ils vont être supprimés

```{r}
prevdf = apply(X = otu_table(ps),
               MARGIN = ifelse(taxa_are_rows(ps), yes = 1, no = 2),
               FUN = function(x){sum(x > 0)})
```

```{r}
prevdf = data.frame(Prevalence = prevdf,
                    TotalAbundance = taxa_sums(ps),
                    tax_table(ps))
```

```{r}
plyr::ddply(prevdf, "Phylum", function(df1){cbind(mean(df1$Prevalence),sum(df1$Prevalence))})
```

```{r}
filterPhyla = c("Dependentiae", "Campilobacterota", "Elusimicrobiota", "Fibrobacterota", "Hydrogenedentes", "NB1-j")
```
Nous allons retirer les phyla qui sont en ptit nombre ( -10 dans l'assignation taxonmique)


```{r}
ps1 = subset_taxa(ps, !Phylum %in% filterPhyla)
ps1
```

```{r}
prevdf1 = subset(prevdf, Phylum %in% get_taxa_unique(ps1, "Phylum"))
ggplot(prevdf1, aes(TotalAbundance, Prevalence / nsamples(ps),color=Phylum)) +
  # Include a guess for parameter
  geom_hline(yintercept = 0.05, alpha = 0.5, linetype = 2) +  geom_point(size = 2, alpha = 0.7) +
  scale_x_log10() +  xlab("Total Abundance") + ylab("Prevalence [Frac. Samples]") +
  facet_wrap(~Phylum) + theme(legend.position="none")
```


```{r}
prevalenceThreshold = 0.05 * nsamples(ps)
prevalenceThreshold
```

```{r}
keepTaxa = rownames(prevdf1)[(prevdf1$Prevalence >= prevalenceThreshold)]
ps2 = prune_taxa(keepTaxa, ps)
```


```{r}
length(get_taxa_unique(ps2, taxonomic.rank = "Genus"))
```
On prend ps2 le filtrage et la prévalence, on lui assigne jusqu’au rang «genre» les ASV. Obtenir la longueur des vecteurs de ps2.

```{r}
ps3 = tax_glom(ps2, "Genus", NArm = TRUE)
```
Cette méthode permet de fusionner des espèces qui ont la même taxonomie à un certain rang taxonomique, jusqu’au «genre» à partir de ps2, on obtient alors ps3. 

```{r}
h1 = 0.4
ps4 = tip_glom(ps2, h = h1)
```

```{r}
multiPlotTitleTextSize = 15
p2tree = plot_tree(ps2, method = "treeonly",
                   ladderize = "left",
                   title = "Before Agglomeration") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))
p3tree = plot_tree(ps3, method = "treeonly",
                   ladderize = "left", title = "By Genus") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))
p4tree = plot_tree(ps4, method = "treeonly",
                   ladderize = "left", title = "By Height") +
  theme(plot.title = element_text(size = multiPlotTitleTextSize))
```


```{r}
gridExtra::grid.arrange(nrow = 1, p2tree, p3tree, p4tree)
```

# Abondance 

## Selon la profondeur 
```{r}
plot_abundance_P = function(physeq,title = "",
                          Facet = "Order", Color = "Phylum"){
  # Arbitrary subset, based on Phylum, for plotting
  p1f = subset_taxa(physeq, Phylum %in% c("Cyanobacteria"))
  mphyseq = psmelt(p1f)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Profondeur",y = "Abundance",
                              color = Color, fill = Color)) +
    geom_violin(fill = NA) +
    geom_point(size = 1, alpha = 0.3,
               position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}
```

```{r}
ps3ra_P = transform_sample_counts(ps3, function(x){x / sum(x)})
```

```{r}
plotBefore_P = plot_abundance_P(ps3,"")
plotAfter_P = plot_abundance_P(ps3ra_P,"")
```

```{r}
gridExtra::grid.arrange(nrow = 1, plotBefore_P, plotAfter_P)
```

```{r}
psOrd_P = subset_taxa(ps3ra_P, Order == "Synechococcales")
plot_abundance_P(psOrd_P, Facet = "Genus", Color = NULL)
```


## Selon la date 
```{r}
plot_abundance_D = function(physeq,title = "",
                          Facet = "Order", Color = "Phylum"){
  # Arbitrary subset, based on Phylum, for plotting
  p1f = subset_taxa(physeq, Phylum %in% c("Cyanobacteria"))
  mphyseq = psmelt(p1f)
  mphyseq <- subset(mphyseq, Abundance > 0)
  ggplot(data = mphyseq, mapping = aes_string(x = "Date",y = "Abundance",
                              color = Color, fill = Color)) +
    geom_violin(fill = NA) +
    geom_point(size = 1, alpha = 0.3,
               position = position_jitter(width = 0.3)) +
    facet_wrap(facets = Facet) + scale_y_log10()+
    theme(legend.position="none")
}
```

```{r}
ps3ra_D = transform_sample_counts(ps3, function(x){x / sum(x)})
```

```{r}
plotBefore_D = plot_abundance_D(ps3,"")
plotAfter_D = plot_abundance_D(ps3ra_D,"")
```

```{r}
gridExtra::grid.arrange(nrow = 1, plotBefore_D, plotAfter_D)
```


```{r}
psOrd_D = subset_taxa(ps3ra_D, Order == "Synechococcales")
plot_abundance_D(psOrd_D, Facet = "Genus", Color = NULL)
```


# Ordination 

```{r}
# Transform data to proportions as appropriate for Bray-Curtis distances
ps.prop <- transform_sample_counts(ps, function(tax_table) tax_table/sum(tax_table))
ord.pcoa.bray <- ordinate(ps.prop, method="PCoA", distance="bray")
```

## Visualisation de l'ordination

```{r}
plot_ordination(ps.prop, ord.pcoa.bray, color="Profondeur", shape = "Date", title="Bray PCoA")
```
L'interprétation d'un tracé de PCoA est simple : les objets ordonnés plus près les uns des autres sont plus similaires que ceux ordonnés plus loin. La (dés)similitude est définie par la mesure utilisée dans la construction de la matrice de (dés)similitude utilisée en entrée. Les valeurs négatives correspondent à des nombres imaginaires sont générés lors de l'analyse et empêchent la représentation euclidiennes.

Analyse :
Pour mars 2015 (triangles), les points représentants les échantillons provenants du fond et de la surface sont très proches. Cela signifie que lors de l'échantillonage, la diversité des OTU était quasiment la même. En revanche, ce n'est pas le cas pour septembre 2014, les points représentants les différentes profondeurs sont très élooignés les uns les autres traduisant une population diversifiée à chaque niveau de profondeur. Les échantillons du médian et de la surface sont de toutde même assez proches contrairement aux points représentant les échantillons provenant du fond qui est totalement éloigné des autres points. Cela traduit donc un désaccord au niveau des OTU retrouvés. 
En comparant les points entre les dates, pour la surface, les OTU semblent très éloignés entre eux. Cela montre ainsi que selon la saison, la diversité change totalement. Nous constatons cette importante différence pour les échntillons provenant du fond. 


```{r}
ps <- prune_samples(rowSums(otu_table(ps)) > 1000, ps)
pslog <- transform_sample_counts(ps, function(x) log(1 + x))
```


```{r}
out.dpcoa.log <- ordinate(pslog, method = "DPCoA")
evals <- out.dpcoa.log$eig
plot_ordination(pslog, out.dpcoa.log, color = "Date",
                  shape = "Profondeur") +
  labs(col = "Date", shape = "Profondeur")+
  coord_fixed(sqrt(evals[2] / evals[1]))
```


```{r}
plot_ordination(pslog, out.dpcoa.log, type = "species", color = "Phylum") +
  coord_fixed(sqrt(evals[2] / evals[1]))
```


# Bar plot

```{r}
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:10]
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
plot_bar(ps.top20, x="Date", fill="Phylum") + facet_wrap(~Profondeur, scales="free_x")
```



```{r}
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[1:20]
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
plot_bar(ps.top20, x="Date", fill="Genus") + facet_wrap(~Profondeur, scales="free_x")
```

Pour le fond de la rade de Brest pour les deux dates, on retrouve en plus grande proportion le genre de clade Ia (vert), puis en plus ptit quantité les SUP05 cluster (violet) et apres les NS5 marine group (bleu). Sachant qu'il y a une grande propotion dans les deux cas de NA. 

Pour le médian, on trouve en majorité le cladIa , puis les Synechoccocus CC9902 (rose) avec les Ascidiceihabitans (marron) dans des proportions équivalentes. 

Pour la surface les Synechoccocus CC9902 domine en septembre alors que c'est le clade IA en mars. Le deuxième genre majoritaire en septembre est le clade IA, alors que pour mars c'est des SUP05 cluster. Sachant qu'il y a une grande propotion de non caractérisé. Pour mars 2015, les A scidiaceihabitans et les Synechoccocus CC9902 ne sont plus présents. 

En ce qui concerne le fond, hormis le fait qu'il n'y ait plus la présence d'Amylibacter en 2015, les genres retrouvés sont les même à des abondances plus faibles mais restent proportionnelles.

Globalement on a un genre qui se trouve dans n'importe qu'elle profondeur qu'elle que soit la date c'est le cladeIa. La seule différente entre les date que l'on peut noter pour les genres est dans la surface. En effet on les Synechoccocus CC9902 qui domine en septembre.


```{r}
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[175:179]
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
plot_bar(ps.top20, x="Date", fill="Phylum",title="Obersvation des phyla avec le phylum crenarche") + facet_wrap(~Profondeur, scales="free_x")
```

```{r}
top20 <- names(sort(taxa_sums(ps), decreasing=TRUE))[283:286]
ps.top20 <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
ps.top20 <- prune_taxa(top20, ps.top20)
plot_bar(ps.top20, x="Date", fill="Phylum", title="Obersvations des phyla avec le phylum thermoplasmatota (archée)") + facet_wrap(~Profondeur, scales="free_x")
```


Les deux derniers bar plot servent à indiquer à quelle profondeur se situe les phyla des archées Crenarchaeota et Thermoplasmatota. NOus voyons qu'elles sont plus présentes dans le fond pour les deux années, assez peu au niveau médian et sont présentes en plus grande quantité que le médian mais reste inférierus à celles du fond. De plus, en surface les archées ne sont présentes qu'en mars 2015. 
Pou r l'années 2014, le fond a présenté une plus grande quantité de phyla d'archée contrairement à mars 2015, qui peut être expliqué par le fait qu'une partie de cette population se retrouve en surface.


# Analyse en réseau 
```{r}
net <- make_network(ps, max.dist=0.35)
sampledata <- data.frame(sample_data(ps))
V(net)$date <- sampledata[names(V(net)), "Date"]
V(net)$Profondeur <- sampledata[names(V(net)), "Profondeur"]
net_graph <- ggnetwork(net)
ggplot(net_graph, aes(x = x, y = y, xend = xend, yend = yend), layout = "fruchtermanreingold") +
  geom_edges(color = "darkgray") +
  geom_nodes(aes(color = date, shape = Profondeur),  size = 3 ) +
  theme(axis.text = element_blank(), axis.title = element_blank(),
        legend.key.height = unit(0.5,"line")) +
  guides(col = guide_legend(override.aes = list(size = .5)))
```
Les échantillons prélevé en mar 2015( bleu) sont relier entre eux que sois en surface ou dans le fonds. Les communautés sont donc en lien. Les échantillons en septembre 2014 sont divisié en deux groupe. On a ceux retrouve que en fond et donc des communauté particilère, et apres les médian et fond ont de lien. 

On pourrais expliquer ce resultat. On peut supposer que la date de spetembre correspon à l'automne 2014 et que la date de mars plus au printemps un an après. Pendant l'hiver , souvent la mer est plus mouvementé du au temppête et au courant (ex: gulf stream) donc mars pourrais correspondre au conséquence de l'hivers d'ou peut être des différence entre le fond/ médian et la surface. Pour les échantillons de spetembre c'est donc après l'été , la mer est mouvementé normalement. 

On a ceux retrouve que en fond et donc des communautés particulières, et apres les médian et surface ont un lien. Cette analyse en réseau correspond bien aux résultats observés avec l'ordination de la PCoA.


Avec les différentes analyses, nous avons pu voir une changements des communautés bactérienne en fontion de la date et de la profondeur . A savoir que les changements avec la dates sont plus marquanté que la profondeur 
Nous pouvons émettre plusieurs hypothèses possibles suites à ces variations : 

- Au début de l'année 2014, de nombreuses tempêtes ont fait rage au large de la Bretagne, il y a pu avoir une repercussion au nivaau de la diversité des OTU échantilonés en septembre. 

- Le Gulf Stream passe près de la Bretagne, ce courant peu apporter de nouvelles espèces provenant du Nord. 

- Avec le réchauffement climatique, la température de la mer notamment au niveau de la surface peu modifier le milieu et donc avoir un changment au niveau des communautés bactériennes. 

- La rade de Brest possède une grande activité maritime : commerciale et millitaire. Il est possible qu'avec ces échanges, les bateux iportent ou exportent diverses communauté bactériennes.
